---
layout: post
title:  2pc 和 3pc
subtitle:   
date:   2019-09-28
author: fengjp
catalog:    true
tags:
    - 分布式
---

#   2pc 两阶段提交协议 和 3pc 三阶段提交协议

##  背景

本地事务通过 ACID 很好的保证了数据的原子性、一致性和隔离性，因为数据在本地的操作过程永远都是可见的。而当今许多软件框架对系统有扩展性要求，系统扩展引起资源的分布扩展，分布的资源增加了支持系统的可伸缩性，但是同时也带来一致性的问题。如：一个事务涉及到不同资源管理器的资源变更，如何保证这些资源在分布式资源管理器中保持同时变或者同时不变呢？

在分布式系统中，__每个节点机器能清楚知道自己执行的事务操作结果是成功或是失败，但是无法知道其他节点的执行结果，因为每个节点只是全局事务的一个参与者。__ 为了清楚全局事务在各个节点中的执行结果如何，一种方案是 __引入一个协调者来统一调度所有分布式节点的执行情况__ ，其他被调度的节点称为参与者。通过解释 2pc 和 3pc 来理解二者的区别和优缺点。

##  分布式系统和分布式系统一致性问题

分布式系统，即运行在多台不同的网络计算机上的软硬件系统，并且仅通过 __消息传递__ 来进行通信和协调。

　　分布式一致性问题，即相互独立的节点之间如何就一项决议达成一致的问题。

##  两阶段提交

两阶段提交协议是为了解决基于分布式系统架构的所有节点在事务处理过程中保持一致性和原子性的问题。目前绝大多数的关系型数据库都是采用 2pc 来完成事务的提交，全局事务的参与者基于协调者的统一决定是否提交事务。  
__作用__ ：在一定程度上保证了事务的一致性和原子性，因此该协议被广泛使用。

##  阶段一 准备阶段 prepare

事务询问

1、协调者向所有参与该事务的参与者发送事务内容，询问是否能提交事务内容，并等待参与者响应

执行事务

2、各个参与者收到事务内容后，开始执行事务操作，资源管理器将 redo 和 undo 的日志写入事务日志

参与者响应协调者

3、如果参与者执行成功，会给协调者发送成功响应，如果失败发送失败响应

##  阶段二 提交阶段 commit

事务协调者收到参与者发送的响应，并根据响应决定事务是否提交。

### 提交事务

如果收到的响应全为成功响应

1、协调者向所有参与者发送 commit 消息，请求所有参与事务的参与者提交事务，并等待参与者的响应

2、事务参与者收到 commit 消息后，执行 commit 操作提交事务，并返回执行结果，提交后释放事务执行提交所占用的事务资源

3、协调者接收到所有参与者的 ACK 消息后，完成事务提交操作

### 回滚事务

如果协调者收到一个失败响应或者等待超时后，协调者无法接收到所有参与者的反馈响应，则中断事务

1、协调者向事务参与者发送 rollback 请求，请求所有参与者将事务进行回滚

2、参与者收到事务 rollback 请求后，将利用事务日志的 undo 日志进行事务回滚，并将操作结果返回给协调者

3、协调者收到参与者反馈的 ACK 消息后，完成事务中断

##  缺点

1、同步阻塞，所有参与者和事务都处于阻塞状态

2、单点故障，协调者出故障，参与者会一直处于锁定状态

3、脑裂，在阶段二中，如果只有部分参与者执行提交操作，会导致节点数据不一致

##  讨论

数据在网络中传输有许多不确定因素，这个协议存在时间和空间上的漏洞

阶段一，无论协调者或参与者出问题，因为事务还没提交，所有已经执行的事务可以利用在事务日志保存的 undo 日志来回滚。

阶段二，因为事务已经进入 commit 阶段，此时如果协调者或者参与者出问题，都会造成全局资源一致性问题。例如，协调者出现问题，此时部分参与者已经提交了事务，剩下的参与者不知道是要提交还是回滚。

__结果就是出现全局数据一致性问题__

三阶段提交协议可以减少这种不确定性

##  三阶段提交

3pc 其实是 2pc 的一个改进，将 2pc 的准备阶段分为两个阶段，形成 canCommit、 preCommit、 doCommit 三个阶段来进行事务的处理。

##  阶段一 canCommit

事务询问

1、协调者向各个参与者发送一个包含事务内容的 canCommit 请求，询问是否可以执行事务内容，并等待参与者响应

参与者响应

2、参与者收到协调者发来的 canCommit 请求后，如果认为自己可以顺利执行事务，则返回成功响应，否侧返回失败响应。

##  阶段二 preCommit

### 协调者收到所有参与者的成功响应

执行事务预提交

1、协调者向所有参与者发送 preCommit 请求，并等待参与者响应

2、参与者收到 preCommit 请求后，执行事务内容，并将 undo 日志和 redo 日志写入事务日志中

3、参与者反馈各自的执行结果 成功或失败响应，等待下一步指令

### 任何一个参与者失败响应或者等待参与者响应超时

中断事务

1、协调者向所有参与者发出中断请求

2、参与者收到协调者发出的中断请求或者接收请求超时，都会进行中断事务。

##  阶段三 doCommit

### 协调者收到所有参与者的成功响应

1、协调者向各个参与者发送 doCommit 请求

2、参与者收到 doCommit 请求后，将事务提交并释放整个事务期间占用的事务资源

3、参与者向协调者发送 成功 响应

4、协调者收到所有参与者反馈的成功响应后，将完成事务提交

### 任何一个参与者失败响应或者等待参与者响应超时

1、协调者将向参与者发送中断请求

2、参与者收到中断请求后，将利用事务日志的 undo 日志进行事务回滚

3、参与者向协调者反馈 成功 响应

4、协调者收到所有参与者发送的消息后，完成事务中断

注意：进入第三阶段后，无论协调者出问题或者网络出问题，都将导致部分参与者无法接收到 commit 请求或 中断请求。此时，参与者在等待超时后，执行事务提交操作。

##  讨论

如果在第三阶段，协调者出现故障，因为进入第三阶段，参与者是知道其他参与者参加过询问并且返回成功响应，__询问的意义在于确定所有参与者当前能正确执行事务__，参与者在等待超时后，会将事务提交。

如果是参与者有问题，协调者不管有没有问题，因为参与者无法回滚已经执行的事务，因此存在全局资源一致性问题，但经过第一阶段，这种情况出现的比较少。

##  缺点

脑裂问题，如果第三阶段协调者出问题，参与者在等待超时后会自动提交事务，这样会引起系统全局资源的不一致性。但实际上先经过询问事务能否提交出现全局资源不一致的问题比较少。

##  优点

避免同步阻塞，协调者或者参与者在等待超时后，第二阶段会进行事务中断

避免单点故障，如果协调者出问题，在第三阶段，参与者会在超时后将事务提交

##  后记

2pc 和 3pc 都不能很好解决分布式系统一致性的问题，paxos 才能解决这些问题

[分布式 2pc 和 3pc](https://blog.51cto.com/11821908/2058651)

[Mysql 的 2pc 过程](https://www.cnblogs.com/duanzexun/articles/10723628.html)