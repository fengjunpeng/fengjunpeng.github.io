---
layout: post
title:  内存分配与回收策略
subtitle:   内存分配与回收策略
date:   2019-09-12
author: fengjp
catalog:    true
tags:
    - java
---

# 内存分配与回收策略

## Minor GC 和 Full GC

- Minor GC ：回收新生代，因新生代对象存活时间很短，因此 Minor GC 会频繁执行，执行速度一般也比较快

- Full GC ：回收老年代和新生代，老年代对象存活时间长，Full GC 很少执行，执行速度会比 Minor GC 慢很多。

## 内存分配策略

### 1、对象优先在 Eden 上分配

大多数情况下，对象在 Eden 上分配存储空间，当 Eden 空间不足时，发起 Minor GC。

### 2、大对象直接进入老年代

大对象指的是需要连续内存空间的对象，最典型是那种很长的字符串以及数组。

经常出现大对象会提前触发垃圾回收以获得足够的空间分配给大对象。

-XX:PretenureSizeThreshold，大于此值的对象直接在老年代分配，避免在 Eden 和 Survivor 之间的大量内存复制。

### 3、长期存活的对象进入老年代

为对象定义年龄计数器，对象在 Eden 出生并经过 Minor GC 后依然存活，年龄加 1 ，每触发一次年龄就加 1 ，增加到一定年龄移动到老年代。

### 4、动态对象年龄判定

虚拟机不用所有对象的年龄达到 MaxTenuringThreshold 才能晋升老年代，如果在 Survivor 中相同年龄的所有对象超过 Survivor 空间的一半，则年龄大于或等于该年龄的对象可以直接进入老年代。

### 5、空间分配担保

在发生 Minor GC 之前，虚拟机检查老年代最大可用连续空间是否大于新生代所有对象总空间，如果条件成立，那么 Minor GC 可以确认是安全的。

如果不成立，虚拟机查看 HandlePromotionFailure 的值是否允许担保，如果允许，就会继续检查老年代最大可用连续空间是否大于历次晋升到老年代对象的平均大小，如果大于，将尝试进行一次 Minor GC；如果小于，或者不允许担保，就要进行一次 Full GC。

### Minor GC 触发条件

当 Eden 空间满了，将触发一次 Minor GC。

### Full GC 触发条件

#### 1、调用 Sy'stem.gc()

只是建议虚拟机执行 Full GC，但是虚拟机不一定真正执行。不建议这种操作，而让虚拟机管理内存。

#### 2、老年代空间不足

常见场景是 __大对象进入老年代__、 __长期存活的对象进入老年代__ 等。

为避免以上原因引起 Full GC，尽量避免创建过大的对象或数组。可以尝试 -Xmn 调大新生代的大小。或者通过调大对象进入老年代的年龄。

#### 3、空间分配担保失败

使用复制算法的 Minor GC 需要老年代的内存空间作为担保，

