---
layout: post
title:  网络基础知识
subtitle:   
date:   2019-09-25
author: fengjp
catalog:    true
tags:
    - 网络
---

#   网络基础知识

##  OSI 开放式互联参考模型

常用的模型有 5 层、7层。

5 层是 TCP/IP ，7 层是 OSI 模型

OSI 模型是一种概念型框架，注重通信协议必要的功能是什么，没有实现方法，描述进程间通信标准的方法。

TCP/IP 模型是 OSI 模型的一种“实现”，注重在计算机上开发程序要实现哪种协议。

物理层：传输通信比特流，主要定义物理设备的标准，网线类型、光纤接口的类型、以及各种物理介质的传输速率。将比特流转化为电流强弱进行传输，到达目的后在转化为比特流。网卡就是在这一层。

数据链路层：传输比特流容易出现错传、误传，数据链路层定义如何格式化数据传输，以及如何对物理介质进行访问，提供错误检测和纠正，确保数据传输的可靠性。将数据封装为帧，交换机处于这一层，将帧解码并将数据发送到正确的接收方。

网络层：网络节点增加，点对点通信。将 ip 地址翻译成对应的物理地址，并将数据从发送方路由到接收方，综合考虑发送优先权、网络拥塞、可选路由等，决定从一个网络节点到另一个网络节点的最佳路径。路由器属于网络层。数据称为数据包，IP协议，没有确认数据包是否按顺序发送或者包是否丢失，ip 数据包不可靠。

传输层：数据传输要发送大量数据，而网络在传输过程中会发送多次终端，为了保证数据传输的准确性，需要对数据进行切分。解决不同主机传输问题，并且解决传输质量问题。有流量控制，规定适当的发送速率。以太网无法接收大于 1500 字节的数据包，传输层将数据切分为较小的数据包进行发送。传输控制协议TCP，面向连接、可靠、基于字节流的传输层通信协议。 UDP 协议。

会话层：建立和管理不同机器的会话。

表示层：解决不同系统之间通信语法问题。

应用层：规定发送和接收方必须使用固定长度的消息头，消息头要记录消息体长度等一系列信息。http协议

##  TCP 三次握手

将应用层数据切分为报文段，报头 20 字节。

数据包有序号，对方收到则发送 ack 确认报文

使用校验和检验数据是否有错误

端口 进程在计算机内部通信有管道、内存共享、消息传递、信号量等方法，本地使用 pid 标识不同进程，在网络中，使用 tcp + 端口 + ip 地址表示不同进程，即 socket 套接字。

ack 确认序号标志，wei 0 忽略确认号，1 确认号有效

syn 同步序列号标志，用于建立连接

fin finish标志，用于释放连接

单工：支持数据传输在同一个方向上传输，规定一方为发送方、一方为接收方。

半双工：同一个时间内，规定一方为发送一方为接收，二者可以互换，但不能同时发送数据。

全双工：发送和接收方可以同时发送和接收数据。

在双方握手之后，TCP 会在两个机器上建立一个全双工的通信，占用两个机器的通信线路，直到被一方关闭或双方关闭。

首先，服务器和客户端都处于关闭状态，假设客户端主动打开，创建 TCP 连接控制块，服务器端被动打开，进入监听 LISTEN 状态，客户端向服务器端发送 TCP 报文， SYN = 1，seq = x 的数据报文，这个报文不携带任何数据，但是会消耗一个序号，此时服务器处于 SYN_SENT 状态，等待服务器确认。服务器接收到客户端发来的报文，进入 SYN_RCVD 状态，给客户端发送 SYN = 1, ACK = 1, seq = y，ack = x + 1，客户端收到服务器端的响应报文，发送 ACK = 1,seq = x + 1，ack = y + 1 

##  为什么要经历三次握手才能建立连接？

为了初始化 sequence number 初始值

防止已失效报文重新发送到服务器端

##  三次握手存在的问题

三次握手的缺点：如果服务器接收到客户端发来的 SYN 报文并发送 SYN-ACK 报文响应，此时客户端掉线了，服务器没收到客户端的 ACK 报文，服务端会重发 SYN-ACK 报文，Linux 默认重试次数为 5 次，间隔为 1 、 2 、 4 、 8 、 16，一共31秒，在第五次发出去还要等待 32 秒才能判定为超时。SYN Flood 风险，攻击者可以把服务器连接的 SYN 队列耗尽，正常的连接请求不能及时响应。Linux 提出 SYN cookie 应对，当 SYN 队列满了后，通过源地址端口、目标地址端口、和时间戳打造出一个特别的 sequence number 回发回去，如果是攻击者不会将 SYN cookie 回发回来，通过 SYN cookie，即使本次队列已经满了，依然能够建立连接。

##  连接建立后，客户端出现故障

保活机制，在一段时间后，进入保活时间，开启保活一端向对方发送保活探测报文，如果未收到响应则继续发送直到发送数量达到保活探测数，对方主机确认未不可达则中断连接。

##  TCP 四次握手

首先假设客户端主动请求关闭连接，发送 FIN = 1，seq = u 的报文给服务器端，此时客户端进入 FINWAIT1 状态，服务器端收到客户端的报文后，给客户端发送 ACK = 1, seq = v，ack = u + 1 的报文，服务器端进入 COLSEWAIT 状态，此时客户端收到 ACK 报文后，进入 FINWAIT2 状态，服务器端将还未发送的报文在这个时间段发送给客户端，之后服务器端进入被动关闭，服务器端给客户端发送 FIN = 1, ACK = 1, seq = w， ack = u + 1 的报文，并进入 LASTACK 状态，客户端接收到报文后，会发送 ACK = 1, seq = u + 1， ack = w + 1 的报文给服务器端，并进入 TIMEWAIT，2MSL,服务器端收到报文直接关闭。

##  为什么要设置 TIME_WAIT

保证收 ACK 报文那端有足够时间收到 ACK 报文，如果没有收到 ACK ，会触发重发 FIN-ACK 报文，一来一回刚好 2MSL。 MSL 报文最大生存时间。

避免新旧连接混淆，有些路由器会缓存数据包，这些延迟的数据包有可能和旧的数据包混在一起。

##  为什么四次挥手

因为是全双工传输，发送方和接收方都需要发送和接收 FIN 报文和 ACK 报文

##  服务器发生大量 CLOSE_WAIT 原因

客户端关闭 socket ，我方因为忙于其他事而没有及时关闭

- 检查代码，可能是资源没有释放

- 检查配置，可能和线程配置有关

##  UDP

UDP 传输速度仅仅受程序生成报文速度、计算机能力和传输带宽能力限制。报头 8 字节

##  TCP 和 UDP 的区别

连接

可靠

有序性

速度

##  TCP 滑动窗口

RTT：发送一个数据包到接收到 ACK 响应报文的时间。

RTO：重传时间间隔

AdvertiseWindow：接收方能够接收的窗口大小

EffectiveWindow：发送方能发送的数据的窗口大小

TCP 需要直到网络实际带宽或是接收方实际处理速度，才不会引起网络拥塞导致丢包。滑动窗口的作用：1、保证 TCP 的可靠性，2、保证 TCP 的流量控制特性。保证数据传输速率能匹配接收方接收数据的速率。

##  http 和 https 区别

https 在 http 下还有一层 SSL 或 TLS (安全套接层)，为网络通信提供数据安全性和数据完整性的一种协议。方法是采用身份认证和数据加密保证。

https 需要到 CA 证书颁发机构获得数字证书

https 经过加密传输信息

https 默认使用 443 端口， http 采用 80 端口

https = http + SSL + 身份认证

加密方式：

1、对称加密：加密和解密采用相同的密钥

2、非对称加密：加密和解密所使用的密钥不一样，分为公钥和私钥，公钥和算法是公开的一般加密用，私钥是非公开的一般解密用，加密性能较低，加密的数据长度也是有限。

3、哈希算法：将任意长度的信息转换为固定长度的值，算法不可逆

4、数字签名：在信息后加上一段经过哈希后的内容，这些内容可以证明信息没有被修改过。

##  https 数据传输流程

浏览器将支持的加密算法信息发送给服务器

服务器根据浏览器发来的加密算法，把自己的信息以数字证书形式发回浏览器。证书包括证书的发布机构 CA，证书的有效期、公钥和证书所有者、还有签名。证书的公钥用于加密信息，私钥由服务器持有。

浏览器验证证书合法性

如果验证通过或者浏览器接收不受信任的证书，浏览器随机生成用一个对称密钥并用公钥加密，，并用证书的公钥加密发给服务器，服务器用私钥解密后，就能用这个对称密钥进行传输信息，并且能够说明服务器端确实是私钥的持有者。

浏览器验证服务器身份后，浏览器生成一个对称加密算法和密钥，用公钥加密发送给服务器，此时黑客劫持这个信息也没用，只有服务器才能使用私钥对其进行解密。之后客户端和服务器就可以使用这个加密算法和密钥进行加密和解密信息了。

##  https 也未必安全

浏览器默认填充 http:// ，请求需要进行跳转，有劫持风险

##  http

请求结构

请求行 请求头 请求正文 请求头和请求正文一定要用空行隔开

##  http 请求/响应步骤

浏览器连接到服务器

浏览器发送 http 请求

服务器响应请求并返回 http 响应

释放 TCP 连接

客户端获取并解析 html 内容

##  DNS

DNS 代表两种含义：1、由分层的 DNS 服务器组成的分布式数据库，2、提供查询分布式数据库的应用层协议。提供一种域名与 ip 地址转换的服务。

三种类型的DNS服务器：根 DNS 服务器、顶级 DNS 服务器和权威 DNS 服务器

可使用 TCP 或 UDP 传输，端口号 53 ，大多数时候使用 UDP 传输，这就要求 DNS 服务器要自己处理超时重传来保证可靠性。只有特殊情况才使用 TCP 传输：

- 报文长度大于 512 字节（ UDP 最大支持 512 字节数据）

- 区域传输（主域名服务器向辅助域名服务器传输变化的那部分数据）

##  浏览器地址栏数据 url，发生了什么( 只考虑计网 )

### 1、DHCP 配置主机信息

- 假设主机最开始没有 IP 地址及网关 IP 、子网掩码等信息，可以通过 DHCP 协议（动态主机配置协议）来获取。

- 主机生成一个 DHCP 请求报文，并将该报文放入目的端口未为 68 和源端口为 67 的 UDP 报文段中。

- 该报文段进一步被放入一个具有广播 IP 目的地址为255：255：255：255 和源 IP 地址为0：0：0：0 的 IP 数据包中。

- 该 IP 数据包则被封装在 MAC 帧中，该帧具有目的地址 FF:FF:FF:FF:FF:FF ,将广播到与交换机连接的所有设备中。

- 连接在交换机的 DHCP 服务器收到广播帧后，不断向上分解得到 IP 数据包、 UDP 报文段、 DHCP 报文。之后生成 DHCP ACK 报文，该报文包含： IP 地址、 DNS 服务器的 IP 地址、默认网关路由器的 IP 地址和子网掩码。该报文被放入 UDP 报文段中，UDP 报文段被放入 IP 数据包中，并将 IP 数据包封装到 MAC 帧中。

- 该帧的目的地址是请求主机的 MAC 地址，因为交换机具有自主学习的能力，在请求主机发送了广播帧后，就将 MAC 地址记录到其转发接口的交换表项，因此现在交换机可以向哪个接口发送帧。

- 主机收到帧后，一步步向上解析得到 DHCP ACK 报文，并配置好 IP 地址、子网掩码和 DNS 服务器地址、默认网关 IP 地址。

### 2、ARP 获得 MAC 地址

- 主机通过服务器生成 TCP Socket，套接字向 HTTP 服务器发送 HTTP 请求。套接字包括有 TCP 协议、IP、端口，为了生成套接字，要得到域名对应的 IP 地址。

- 

### 3、DNS 域名解析

- 浏览器根据 url 检查浏览器缓存是否有对应的网址映射关系（Chrome:chrome://net-internals/#dns）

- 如果缓存没有找到，则调用 gethostByName() 库函数（操作系统不同函数也不同）进行查询系统的 DNS 解析器缓存

- 在 gethostbyname 函数在进行 DNS 解析之前，会先检查域名是否在本地 hosts 文件里面

- 如果 gethostbyname 函数没找到域名缓存记录，并且 hosts 文件也没找到，则向本地 DNS 服务器发送一条含有指定域名的 DNS 查询请求。本地/ISP DNS 服务器是由网络通信栈提供，通常是 __本地路由器__ 或者 __ISP 的缓存 DNS 服务器__ ，先查询本地路由器缓存，再查询 ISP 的 DNS 服务器缓存

- 如果 DNS 服务器和客户端在同一个子网内，

- 如果查询的域名包含在本地/ISP DNS 服务器的本地配置区域资源中，返回解析结果，此解析具有权威性，查询结束。

- 如果查询的域名不在本地/ISP DNS 服务器本地配置区域中，但是服务器缓存了此域名的映射关系，返回解析结果，查询结束，此解析不具权威性。

- 如果本地/ISP DNS 服务器也失效：  
如果未采用转发模式（迭代），本地 DNS 服务器把查询 DNS 请求发送给 13 台根域名服务器，根域名服务器收到请求后会判断域名是属于哪一个顶级域名服务器管理，并返回顶级域名服务器。本地 DNS 服务器收到请求后会发送 DNS 查询请求给顶级域名服务器，如果顶级域名服务器查到映射关系则返回 IP 地址，如果没有，则找到一个管理该域名的下一级服务器并返回其 IP 地址给本地 DNS 服务器。依次类推，直到解析出 IP 地址或者无法解析当前域名。  
如果采用转发模式（递归）， DNS 服务器如果没有找到域名和 ip 的映射关系，则将查询转发给上一级 DNS 服务器，依次类推  
本地 DNS 服务器把返回的结果保存到本地配置区域文件，以便下次使用，并将获得的 IP 地址返回给客户端。

- 封装 HTTP 请求报文头，通过 DNS 获得的 IP 地址没有在这用到。

- 建立 TCP 连接 