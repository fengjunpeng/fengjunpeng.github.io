---
layout: post
title:  数据库的索引问题
subtitle:   
date:   2019-09-10
author: fengjp
catalog:    true
tags:
---

#   数据库的索引问题

##  索引是什么

增加索引可以快速找出特定的记录，mysql 的索引都是以 B- 树的形式保存。如果没有索引执行查询操作，mysql 会从第一个记录开始查找，直到找到符合条件的记录为止。表的数据越多，操作的代价越高。作为搜索条件的列上创建了索引， mysql 无需全表扫描即可得到目标记录所在的位置。

##  索引的种类

### 普通索引

最基本的索引类型，没有唯一性的限制。

create index < index name > on < tablename > ( 列 )

ALTER TABLE tablename ADD INDEX [ index name ] ( 列 )

### 唯一性索引

与普通索引基本相同，但是唯一区别是：唯一性索引的列表的索引列，必须唯一。

CREATE UNIQUE INDEX <索引的名字> ON tablename (列);

ALTER TABLE tablename ADD UNIQUE [ index name ] ( 列 );

### 主键

主键也是一种唯一性索引，但和索引区别是  
主键是一种约束，有唯一性的性质，但是唯一性索引不一定是主键，  
索引允许为空，主键不能为空，  
主键可以作为外键，但索引不能，  
一张表能创建多个索引，但是主键只有一个。

主键指定为 primary key。

### 全文索引

全文索引在 mysql 后面的 3.23.23 开始，索引类型为 fulltext ，可以建立在 VARCHAR 或 TEXT 上创建。

##  索引优缺点

### 优点

1、加快查询速度，快速找到特定记录

2、利用索引的唯一性标记唯一值

### 缺点

1、占用磁盘空间

2、执行 insert update delete 增加索引维护成本、

##  聚集索引

当数据在数据库中，不加索引的表，数据是逻辑上一行行排列在磁盘中，而加了主键或者索引的表，表的数据的存储方式从逻辑结构上来看，就像是一颗平衡树，因为索引原理就是数据结构中的平衡树（非二叉）。

整个表的数据就变成一个索引，也就是“聚集索引”。为什么一个表只有一个主键？一个表只能有一个“聚集索引”？因为主键的作用就是把表格式的数据存储结构转变为树结构存储结构方式。

树的所有节点（除了底部的多条数据节点），都是由主键字段中的数据构成，在底部的才是真正的数据。比如，有一个查询：

```sql
select * from table where name = 'fjp';
```

首先根据索引取到 ‘fjp’ 这个结点所在的叶结点，再通过叶节点取到 name = ‘fjp’ 的数据。

如果不加索引，10 亿条数据最坏情况下也要 10 亿次才能找到目标数据，而且 10 条数据也不能一次性读入内存，因此，这 10 亿条数据在不经过缓存优化，就是 10 亿次物理 IO 开销，以现在磁盘的 IO 能力，估计要几个月。

如果把这张表加上主键，表结构就会转化为平衡树结构，假设平衡树分支数是 10 ，则查找次数为 log 总数据量/分支数。实际上这个分支数还可以更大。

##  加索引的坏处在哪

索引能使查询事务的速度大大提升，同时也使写入的速度下降，因为平衡树在每次增删改都要维护这个树的结构，每次数据改变时，DBMS 必须去重新维护树的结构，会带来一定的性能开销。

##  非聚集索引

非聚集索引和聚集索引一样，都是通过将索引的字段建立一棵平衡树，来加快查询的效率。是普通索引，不是唯一性索引。可以给表中多个字段增加索引，这些索引互相之间不影响。

每次给字段新增一个索引，字段中的数据会被复制一份，用于建立平衡树。因此添加表索引，会占用更多磁盘空间。

非聚集索引和聚集索引区别是，非聚集索引通过索引获得查找数据的主键，主键通过聚集索引获得查找的数据。

##  覆盖索引

可以不适用聚集索引也能查出所需要的数据，称为覆盖索引。

当索引字段建立后，字段中的内容会同步到索引中，如果为一个索引指定两个字段，那么这两个字段的内容都会被同步到索引中。

---

[B+和B-](http://blog.codinglabs.org/articles/theory-of-mysql-index.html)

[深入浅出数据库索引原理](https://www.cnblogs.com/aspwebchh/p/6652855.html)

##  索引的本质

查找方法有很多，顺序查找、二分查找、二叉查找树，二分查找要求数据必须是满足数据是有序的，二叉查找树只能应用于二叉树，不能满足多种数据结构。在数据库系统中，维护满足特定查找算法的数据结构，这种数据结构就是索引。

实际上数据库系统几乎没有使用二叉查找树或者其相关的红黑树实现。

##  B-Tree 和 B+Tree

目前大部分数据库系统和文件系统都是使用 B-Tree 或者其进化 B+Tree 作为索引的数据结构。

### B-Tree

为了描述 B-Tree ，定义一条数据记录为一个二元组 [ key, data ]，key 是记录的键值，对于不同数据，key 是不相同的； data 为数据记录除 key 以外的数据。那么 B-Tree 满足以下条件：

1、d 为大于 1 的整数，称为 B-Tree 的度

2、h 为一个整数，称为 B-Tree 的高度。

3、每个非叶子结点都由 n - 1 个 key 和 n 个指针组成，其中 d <= n <= 2d;

4、每个叶子结点最少包含 1 个 key 和 2 个指针，最多包含 2d - 1 个 key 和 2d 个指针，叶节点的指针都是 null 。

5、所有的叶子结点都有相同的深度，等于树的高度 h 。

6、key 从左到右非递减排列

7、每个指针要么是 null ，要么指向另外一个节点。

8、如果某个指针在节点node最左边且不为null，则其指向节点的所有key小于v(key1)，其中v(key1)为node的第一个key的值。

9、如果某个指针在节点node最右边且不为null，则其指向节点的所有key大于v(keym)，其中v(keym)为node的最后一个key的值。

10、如果某个指针在节点 node 的左右相邻 key 分别是 keyi 和 keyi+1 且不为 null，则其指向节点的所有key小于v(keyi+1)且大于v(keyi)。

### 查找方法

首先从根节点进行二分查找，如果找到返回对应的节点 data ，否则对相应区间的指针指向的节点递归进行查找，直到找到节点或找到 null 指针。

一个度为d的B-Tree，设其索引N个key，则其树高h的上限为 log d ((N + 1) / 2) - 1，检索一个key，其查找节点个数的渐进复杂度为O ( log d N ) 。从这点可以看出，B-Tree是一个非常有效率的索引数据结构。

### B+Tree

基于 B 树的另外一种数据结构， B+Tree 。 Mysql 普遍使用 B+Tree 来实现索引数据结构。

和 B-Tree 以下特点不一样：

1、每个节点指针上限不是 2d 而是 2d+1；

2、每个非叶子节点不存储数据，只存储 key ，叶子节点不存储指针。

由于并不是所有节点都具有相同的域，叶子节点不包含指针，因此 B+Tree 中叶节点和内节点一般大小不同。这点与B-Tree不同，虽然B-Tree中不同节点存放的 key 和指针可能数量不一致，但是每个节点的域和上限是一致的，所以在实现中B-Tree往往对每个节点申请同等大小的空间。

一般来说，B+Tree比B-Tree更适合实现外存储索引结构

在数据库系统和文件系统中，使用 B+Tree 数据结构都在经典的 B+Tree 上进行优化，增加了顺序访问指针。

在 B+Tree 的每个叶子节点增加访问相邻节点的指针，形成带有顺序访问指针的 B+Tree。当访问到叶子节点时，如果在当前叶子节点没有找到匹配的目标值，可以通过顺序指针一次性查找所有数据节点。目的是提高区间访问性能。

##  为什么使用B-Tree（B+Tree）

其实红黑树、二叉查找树也可以作为索引的数据结构，但是数据库系统和文件系统普遍使用的是 B-/+Tree 来实现索引。可以结合计算机组成原理来讨论 B-/+Tree 作为索引的理论基础。

索引本身也是比较巨大，不可能存在内存中，因此索引一般以索引文件的形式存储在磁盘上。在查找索引的时候就要经过磁盘 IO 操作，这个操作比内存操作慢几个数量级。也就是说尽量减少磁盘 IO 操作的次数来提供查询速度，这是索引作为数据结构要解决的问题。

##  innodb 的主键选择和插入优化

在使用InnoDB存储引擎时，如果没有特别的需要，请永远使用一个与业务无关的自增字段作为主键。

有的人觉得没必要使用业务无关的自增字段作为主键，完全可以使用类似学号或身份证号码的字段作为主键。从业务层面上来看，二者都是行的通的。但从数据库索引优化角度看，不使用自增主键绝对是一个糟糕的选择。

innodb 主键采用聚集索引，每条数据记录都是存放在 B+ 树的叶子节点。这就要求每个叶子节点（一个内存页或磁盘页大小）的各个主键都是按顺序存放的，因此每当有一个新的节点插入时，数据库会根据主键插入适当的位置，保证叶子节点中主键的顺序性。当页面达到装载因子（innodb 默认时 15/16）时，会开辟一个新的页（叶子节点）；

如果使用自增字段作为主键，每次插入新的记录，就会在当前叶子节点的后继位置增加记录，当节点达到装载因子时，就会新开辟一页存放；好处是每次插入不需要移动记录，效率高。

如果使用非自增字段作为主键，每次插入需要判断插入的位置，并且还要移动原来的记录。mysql 为了将记录插入而移动数据，并且有可能原来的页已经被写回到磁盘从而从缓存清除掉，这增加了许多开销，频繁移动导致内存碎片化，后续通过 OPTIMIZE TABLE 来重建表并优化页面。

##  为什么不建议使用过长的字段作为主键

如果主键字段过长，在 innodb 中使用辅助（或者说一般）索引时就会变得非常庞大，因为辅助索引引用的是主键的字段作为 data 域。

##  总结

总的来讲，索引就是帮助 SQL 快速高效获得数据的数据结构。索引的本质是数据结构。


